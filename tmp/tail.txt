
func get_current_xp():
	return player_data["current_xp"]

func get_current_level():
	return player_data["current_level"]

# External callers (e.g., Profile.gd) should call this when avatar image changes
func notify_avatar_changed() -> void:
	emit_signal("avatar_changed")
	# Achievement: I Remember My... (set an avatar)
	achievement_unlock("i_remember_my")

func increment_bonus_spins() -> void:
	player_data["bonus_spins"] = int(player_data.get("bonus_spins", 0)) + 1
	achievement_progress("frequent_flyer", 1)
	if player_data["bonus_spins"] >= 5:
		achievement_unlock("frequent_flyer")
	save_player_data()

func increment_broken_sunglasses() -> void:
	player_data["broken_sunglasses"] = int(player_data.get("broken_sunglasses", 0)) + 1
	save_player_data()

# Safe Achievement helpers
func achievement_unlock(id: String) -> void:
	if Engine.has_singleton("AchievementManager") or (typeof(AchievementManager) != TYPE_NIL):
		if AchievementManager.has_method("unlock_achievement"):
			AchievementManager.unlock_achievement(id)

func achievement_progress(id: String, amount: int) -> void:
	if Engine.has_singleton("AchievementManager") or (typeof(AchievementManager) != TYPE_NIL):
		if AchievementManager.has_method("progress_achievement"):
			AchievementManager.progress_achievement(id, amount)

# MEANER METER API
func get_meaner_meter_current() -> int:
	if typeof(player_data) == TYPE_DICTIONARY:
		var meter = player_data.get("meaner_meter", {})
		if typeof(meter) == TYPE_DICTIONARY:
			return int(meter.get("current", 0))
	return 0

func get_meaner_meter_max() -> int:
	if typeof(player_data) == TYPE_DICTIONARY:
		var meter = player_data.get("meaner_meter", {})
		if typeof(meter) == TYPE_DICTIONARY:
			return int(meter.get("max", 100))
	return 100

func add_to_meaner_meter(delta: int) -> void:
	if delta <= 0:
		return
	var meter = player_data.get("meaner_meter", {"current": 0, "max": 100})
	var cur: int = int((meter.get("current", 0)))
	var mx: int = int((meter.get("max", 100)))
	cur += delta
	var filled_now: bool = false
	if cur >= mx:
		cur = mx
		filled_now = true
	meter["current"] = cur
	player_data["meaner_meter"] = meter
	emit_signal("meaner_meter_changed", cur, mx)
	if filled_now:
		emit_signal("meaner_meter_filled")
	save_player_data()

func reset_meaner_meter() -> void:
	var meter = player_data.get("meaner_meter", {"current": 0, "max": 100})
	meter["current"] = 0
	player_data["meaner_meter"] = meter
	emit_signal("meaner_meter_changed", 0, int(meter.get("max", 100)))
	save_player_data()

func increment_jailbreak_for_color(color: String) -> void:
	if not player_data.has("jailbreaks"):
		player_data["jailbreaks"] = {}
	var jb = player_data["jailbreaks"]
	jb[color] = int(jb.get(color, 0)) + 1
	player_data["jailbreaks"] = jb
	save_player_data()
